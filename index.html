<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Happy Birthday</title>
<style>
  :root{
    --bg1:#0f1023; --bg2:#1a1b3a;
    --text:#ffffff; --muted:#c8c6ff;
    --pink:#ff7eb8; --pink-2:#ff9dc9; --pink-3:#ffc6df;
    --cake-shadow:#0a0b1b;
    --sprinkle:#ffdbe9;
    --gold:#ffd26f; --gold-2:#ffb347; --smoke:#dbe0e8;
    --btn:#7b5cff; --btn2:#ff4fd8;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial;}
  body{
    color:var(--text);
    background: radial-gradient(1200px 800px at 70% -20%, #3b1d6b 0%, transparent 60%),
                radial-gradient(1200px 800px at -20% 120%, #0c2a3a 0%, transparent 60%),
                linear-gradient(180deg, var(--bg1), var(--bg2));
    overflow:hidden;
  }

  /* ---------- Screens ---------- */
  .screen{
    position:absolute; inset:0;
    display:flex; flex-direction:column; align-items:center; justify-content:flex-start;
    padding:28px 18px 120px; gap:26px;
    opacity:0; transform:translateX(40px); transition:opacity .5s ease, transform .5s ease;
    pointer-events:none;
  }
  .screen.active{opacity:1; transform:none; pointer-events:auto;}
  .title{font-size:clamp(28px, 5vw, 46px); font-weight:800; letter-spacing:.5px}
  .subtitle{color:var(--pink-3); font-weight:700; margin-top:-6px}

  /* ---------- Cake ---------- */
  .stage{margin-top:8px; display:flex; flex-direction:column; align-items:center; gap:16px;}
  .plate{
    width:min(680px, 90vw); height:18px; margin-top:4px;
    background: radial-gradient(ellipse at 50% 140%, #00000020 0%, transparent 60%);
    filter: blur(1px);
  }
  .cake{
    position:relative; display:flex; flex-direction:column; align-items:center; gap:18px;
  }
  .tier{
    position:relative; border-radius:18px; box-shadow: 0 10px 28px #0000003a, inset 0 -4px 0 #ffffff20;
    background: linear-gradient(180deg, var(--pink-2), var(--pink));
  }
  .tier.t1{ width:min(560px, 88vw); height:74px;}
  .tier.t2{ width:72%; height:62px;}
  .tier.t3{ width:50%; height:50px;}
  .tier:after{ /* icing edge */
    content:""; position:absolute; inset:0; border-radius:18px;
    background: linear-gradient(180deg, #fff6 0%, #fff0 40% 100%);
    pointer-events:none;
  }
  /* sprinkles (static, neat) */
  .sprinkles{
    position:absolute; inset:10px 14px; pointer-events:none;
    background:
      radial-gradient(2.5px 2.5px at 8% 40%, var(--sprinkle) 98%, transparent 100%),
      radial-gradient(2.5px 2.5px at 26% 70%, var(--sprinkle) 98%, transparent 100%),
      radial-gradient(2.5px 2.5px at 42% 32%, var(--sprinkle) 98%, transparent 100%),
      radial-gradient(2.5px 2.5px at 58% 64%, var(--sprinkle) 98%, transparent 100%),
      radial-gradient(2.5px 2.5px at 74% 36%, var(--sprinkle) 98%, transparent 100%),
      radial-gradient(2.5px 2.5px at 90% 66%, var(--sprinkle) 98%, transparent 100%);
  }
  .t2 .sprinkles{transform:scale(.9)}
  .t3 .sprinkles{transform:scale(.8)}

  /* ---------- Candles ---------- */
  .candles{
    position:absolute; top:-30px; left:0; right:0;
    display:flex; justify-content:center; gap:18px;
  }
  .candle{
    width:18px; height:48px; border-radius:6px; position:relative;
    background:
      repeating-linear-gradient(90deg, #fff 0 6px, #fff0 6px 12px),
      linear-gradient(#ffffff, #ffe8f4);
    box-shadow: inset 0 -4px 0 #00000010;
  }
  .candle:after{ /* wick */
    content:""; position:absolute; top:-10px; left:50%; width:2px; height:12px; transform:translateX(-50%);
    background:#111; border-radius:2px;
  }
  .flame{
    position:absolute; top:-26px; left:50%; transform:translateX(-50%); width:18px; height:26px;
    filter: blur(.2px);
  }
  .flame i, .flame b{
    position:absolute; inset:0; border-radius:50% 50% 50% 50%/60% 60% 40% 40%;
    transform-origin:50% 100%;
  }
  .flame i{ background: radial-gradient(circle at 50% 30%, #fff 0 30%, #ffd86a 30% 65%, #ff8a00 65%); opacity:.95;
            animation:flicker .18s infinite alternate ease-in-out, sway 1.4s infinite ease-in-out; }
  .flame b{ background: radial-gradient(circle at 50% 40%, #fff 0 40%, #ffe19e 40% 70%, #ffa93a 70%);
            filter:blur(3px); opacity:.7; animation:flicker .22s infinite alternate ease-in-out reverse; }
  @keyframes flicker{ from{transform:translateX(-.5px) scaleY(1)} to{transform:translateX(.5px) scaleY(.92)} }
  @keyframes sway{ 0%{transform:translateX(-50%) rotate(-2deg)} 50%{transform:translateX(-50%) rotate(2deg)} 100%{transform:translateX(-50%) rotate(-2deg)}}

  /* out state */
  .candle.out .flame{opacity:0; transition:opacity .18s ease}
  .candle.out .smoke{
    position:absolute; top:-20px; left:50%; transform:translateX(-50%);
    width:4px; height:4px; border-radius:50%; background:var(--smoke); opacity:.8;
    box-shadow: 0 0 14px #ffffffaa;
    animation: puff 1s ease-out forwards;
  }
  @keyframes puff{
    0%{ transform:translate(-50%, 0) scale(1); opacity:.9 }
    100%{ transform:translate(-50%, -32px) scale(3); opacity:0 }
  }

  /* ---------- Buttons ---------- */
  .controls{display:flex; gap:14px; flex-wrap:wrap; justify-content:center}
  button{
    border:0; padding:14px 20px; border-radius:18px; font-weight:800; font-size:16px;
    color:#fff; cursor:pointer; transition:transform .08s ease, box-shadow .2s ease, opacity .2s ease;
    background: radial-gradient(120% 120% at 20% 20%, var(--btn2), var(--btn));
    box-shadow: 0 10px 22px #00000035;
  }
  button:active{ transform:translateY(1px) scale(.99) }
  .ghost{
    background: linear-gradient(180deg, #2a2a4d, #242446);
    border:1px solid #ffffff14;
  }

  /* ---------- Letter ---------- */
  .letter{
    width:min(680px, 92vw); padding:22px 18px; border-radius:18px;
    background:linear-gradient(180deg, #ffffff, #f9f6ff);
    color:#2c2940; box-shadow:0 20px 36px #00000030;
  }
  .letter h3{margin:0 0 8px 0; font-size:22px}
  .letter textarea{
    width:100%; height:240px; border-radius:12px; padding:14px; font-size:16px; line-height:1.5;
    border:1px solid #e7dfff; resize:vertical; outline:none;
  }

  /* ---------- Confetti canvas ---------- */
  canvas#confetti{position:absolute; inset:0; pointer-events:none}

  /* ---------- Footer dots (palette) ---------- */
  .dots{position:absolute; left:0; right:0; bottom:14px; display:flex; gap:14px; justify-content:center; opacity:.85; filter:saturate(.9)}
  .dot{width:46px; height:46px; border-radius:50%; background:#fff2; box-shadow:inset 0 -4px 0 #0002}
</style>
</head>
<body>

<canvas id="confetti"></canvas>

<!-- Screen 1: Cake -->
<section class="screen active" id="screen-cake" aria-label="Cake">
  <div style="text-align:center;margin-top:8px">
    <div class="title">Happy Birthday</div>
    <div class="subtitle">To someone amazing üíñ</div>
  </div>

  <div class="stage" aria-hidden="false">
    <div class="cake">
      <div class="tier t3"><div class="sprinkles"></div>
        <div class="candles" id="candles">
          <!-- tidy, evenly spaced candles -->
          <div class="candle"><div class="flame"><i></i><b></b></div></div>
          <div class="candle"><div class="flame"><i></i><b></b></div></div>
          <div class="candle"><div class="flame"><i></i><b></b></div></div>
          <div class="candle"><div class="flame"><i></i><b></b></div></div>
          <div class="candle"><div class="flame"><i></i><b></b></div></div>
        </div>
      </div>
      <div class="tier t2"><div class="sprinkles"></div></div>
      <div class="tier t1"><div class="sprinkles"></div></div>
    </div>
    <div class="plate" aria-hidden="true"></div>
  </div>

  <div class="controls">
    <button id="startMic" class="ghost">üéôÔ∏è Start mic</button>
    <button id="tapToBlow">üí® Tap to blow</button>
    <button id="openLetter" class="ghost" style="display:none">üíå A Special Letter</button>
  </div>

  <div id="micNote" style="opacity:.8">Tip: allow microphone access or use <b>Tap to blow</b>.</div>

  <div class="dots" aria-hidden="true">
    <div class="dot" style="background:#ff8dbb"></div>
    <div class="dot" style="background:#ffe177"></div>
    <div class="dot" style="background:#aee7ff"></div>
    <div class="dot" style="background:#bdef86"></div>
    <div class="dot" style="background:#dfc2ff"></div>
    <div class="dot" style="background:#ff90be"></div>
    <div class="dot" style="background:#ffe177"></div>
  </div>
</section>

<!-- Screen 2: Letter (separate page) -->
<section class="screen" id="screen-letter" aria-label="Letter">
  <div class="title">A Special Letter</div>
  <div class="subtitle">Just for you, on your day ‚ú®</div>

  <div class="letter">
    <h3>Your message</h3>
    <textarea id="msg" placeholder="Write your birthday message here‚Ä¶"></textarea>
    <div style="display:flex; gap:10px; margin-top:12px">
      <button id="readBack" class="ghost">üîä Read</button>
      <button id="backToCake">‚¨ÖÔ∏è Back</button>
    </div>
  </div>
</section>

<script>
/* ---------- Helpers ---------- */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));

function goTo(id){
  document.querySelectorAll('.screen').forEach(sc => sc.classList.remove('active'));
  $(id).classList.add('active');
  // subtle page transition confetti when arriving at letter
  if(id==='#screen-letter'){ burstConfetti(180, 10); }
}

/* ---------- Candles logic ---------- */
const candles = $$('#candles .candle');
let blown = false;

function putOutCandles(){
  if (blown) return;
  blown = true;
  candles.forEach(c=>{
    c.classList.add('out');
    // little puff
    const puff = document.createElement('div');
    puff.className='smoke';
    c.appendChild(puff);
    setTimeout(()=>puff.remove(), 1100);
  });
  // celebrate!
  confettiStorm();
  $('#openLetter').style.display='inline-block';
}

$('#tapToBlow').addEventListener('click', putOutCandles);

/* ---------- Mic blow detection (gain threshold) ---------- */
let micStream, audioCtx, analyser, dataArray, threshold = 36, armed = false;

async function startMic(){
  try{
    micStream = await navigator.mediaDevices.getUserMedia({ audio:true });
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const src = audioCtx.createMediaStreamSource(micStream);
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 1024;
    dataArray = new Uint8Array(analyser.fftSize);
    src.connect(analyser);
    armed = true;
    $('#micNote').textContent = 'Listening‚Ä¶ blow towards the mic!';
  }catch(e){
    $('#micNote').textContent = 'Could not access microphone. Use the üí® Tap to blow button.';
  }
}
$('#startMic').addEventListener('click', startMic);

function listen(){
  if(!analyser || !armed || blown) { requestAnimationFrame(listen); return; }
  analyser.getByteTimeDomainData(dataArray);
  // simple RMS loudness
  let sum = 0;
  for(let i=0;i<dataArray.length;i++){ const v = (dataArray[i]-128)/128; sum += v*v; }
  const rms = Math.sqrt(sum / dataArray.length) * 100; // ~0‚Äì100
  if(rms > threshold){ putOutCandles(); armed = false; }
  requestAnimationFrame(listen);
}
listen();

/* ---------- Confetti (no libraries) ---------- */
const cvs = $('#confetti'), ctx = cvs.getContext('2d');
let W,H, confetti = [];
function resize(){ W= cvs.width = window.innerWidth; H= cvs.height = window.innerHeight; }
window.addEventListener('resize', resize); resize();

function spawn(n=140, spread=1){
  for(let i=0;i<n;i++){
    confetti.push({
      x: Math.random()*W, y: -20*Math.random(),
      r: 4 + Math.random()*5,
      s: 2 + Math.random()*3,
      a: Math.random()*Math.PI*2,
      hue: Math.floor(Math.random()*360),
      tilt: Math.random()*0.8 + 0.2,
    });
  }
}
function confettiStorm(){ spawn(220); }
function burstConfetti(n=120, spread=6){
  for(let i=0;i<n;i++){
    confetti.push({
      x: W/2 + (Math.random()-0.5)*W/spread, y: H/2 + (Math.random()-0.5)*H/spread,
      r: 4 + Math.random()*5, s: 2 + Math.random()*3,
      a: Math.random()*Math.PI*2, hue: Math.floor(Math.random()*360), tilt: Math.random()*0.8+0.2
    });
  }
}
(function loop(){
  ctx.clearRect(0,0,W,H);
  confetti.forEach((p,idx)=>{
    p.y += p.s; p.x += Math.sin((p.y+p.a)/30)*1.2; p.a += 0.01;
    ctx.save(); ctx.translate(p.x, p.y); ctx.rotate(p.a*p.tilt);
    ctx.fillStyle = `hsl(${p.hue} 90% 60%)`;
    ctx.beginPath(); ctx.moveTo(0,-p.r); ctx.lineTo(p.r,p.r); ctx.lineTo(-p.r,p.r); ctx.closePath(); ctx.fill();
    ctx.restore();
    if(p.y > H+40) confetti.splice(idx,1);
  });
  requestAnimationFrame(loop);
})();

/* ---------- Navigation ---------- */
$('#openLetter').addEventListener('click', ()=>goTo('#screen-letter'));
$('#backToCake').addEventListener('click', ()=>goTo('#screen-cake'));

/* ---------- Optional: read message back ---------- */
$('#readBack').addEventListener('click', ()=>{
  const t = $('#msg').value || "Happy Birthday! Wishing you a beautiful year ahead.";
  const u = new SpeechSynthesisUtterance(t); u.rate = 1.02; speechSynthesis.speak(u);
});
</script>
</body>
</html>
